pipeline {
  agent none
  stages {
    stage('Spack-stack-test') {
       agent {
        label 'built-in'   
       }
      steps {
        script {
          for (label in pullRequest.labels) {
            if ((label.matches("hercules"))) {
                 env.CHOICE_NODE='hercules'
            } 
            else { 
                env.CHOICE_NODE='none'
            }
         }
// Why do I need another if..block, because it just works this way.

            if (CHOICE_NODE == 'hercules') {
                echo "Starting up hercules ${CHOICE_NODE}...this might take 5-10 minutes...please be patient."
            }
             else {
                echo "${CHOICE_NODE} is NOT a platform, moving on..."
            }
       }    
    }
  } 
  stage('Test spack-stack on Hercules') {
        agent {
          label "hercules"
        }
        environment {
        ACCNR = 'nems'
        NODE_PATH = '/work/noaa/epic/role-epic/'
      }
      steps {
          
        cleanWs()
        checkout scm
        sh '''
        cd /work/noaa/epic/role-epic/spack-stack/hercules/spack-stack-1.5.0
        rm -rf log.concretize.unified-env.001
        rm -rf log.install.unified-env.001
        module purge
        module use /work/noaa/epic/role-epic/spack-stack/hercules/modulefiles
        module load ecflow/5.8.4
        module load mysql/8.0.31
        source ./setup.sh
        spack env activate -p envs/unified-env
        spack concretize 2>&1 | tee log.concretize.unified-env.001
        spack install --verbose 2>&1 | tee log.install.unified-env.001
        spack module lmod refresh -y
        spack stack setup-meta-modules
        module use /work/noaa/epic/role-epic/spack-stack/hercules/spack-stack-1.5.0/envs/unified-env/install/modulefiles/Core
        module load stack-gcc/11.3.1 openmpi/4.1.5 stack-openmpi/4.1.5 jasper/2.0.32 zlib/1.2.13 libpng/1.6.37 hdf5/1.14.0
        module load netcdf-c/4.9.2 netcdf-fortran/4.6.0 parallelio/2.5.10 esmf/8.4.2 fms/2023.02 bacio/2.4.1 crtm/2.4.0 g2/3.4.5
        module load g2tmpl/1.10.2 ip/4.3.0 sp/2.3.3 w3emc/2.10.0 gftl-shared/1.5.0 mapl/2.35.2-esmf-8.4.2 scotch/7.0.4
        module list
        '''
      }
      }
    }
  }
