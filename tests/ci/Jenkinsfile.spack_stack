pipeline {
  agent none
  stages {
    stage('Start Hercules Cluster') {
       agent {
        label 'built-in'   
       }
      steps {
        script {
          for (label in pullRequest.labels) {
            if ((label.matches("Stack_Build"))) {
                 env.CHOICE_NODE='Hercules'
            } 
            else { 
                env.CHOICE_NODE='none'
            }
         }
// Why do I need another if..block, because it just works this way.

            if (CHOICE_NODE == 'Hercules') {
                echo "Starting up Hercules cluster ${CHOICE_NODE}...this might take 5-10 minutes...please be patient."
            }
             else {
                echo "${CHOICE_NODE} is NOT a Parallelworks cluster, moving on..."
            }
       }    
    }
  } 
  stage('Run Regression Tests script') {
        agent {
          label "${CHOICE_NODE}"
        }
        environment {
        ACCNR = 'nems'
        NODE_PATH = '/work/'
      }
      steps {
          }
        }
        cleanWs()
        checkout scm
        sh '''
        pwd
        git clone --recurse-submodules https://github.com/ufs-community/ufs-weather-model
        cd ufs-weather-model/modulefiles/
        sed -i 's|/work/noaa/epic/role-epic/spack-stack/hercules/spack-stack-dev-20230825/envs/ufs-pio-2.5.10/install/modulefiles/Core|/work/noaa/epic/role-epic/spack-stack/hercules/spack-stack-1.5.0/envs/unified-env/install/modulefiles/Core|g' ufs_hercules.gnu.lua 
        sed -i 's|/work/noaa/epic/role-epic/spack-stack/hercules/modulefiles|/work/noaa/epic/role-epic/spack-stack/hercules/modulefiles|g' ufs_hercules.gnu.lua
        sed -i 's|stack_python_ver=os.getenv("stack_python_ver") or "3.9.14"|stack_python_ver=os.getenv("stack_python_ver") or "3.10.8"|g' ufs_hercules.gnu.lua 
        sed -i 's|3.3.3|4.3.0|g' ufs_hercules.gnu.lua 
        sed -i 's|2.9.2|2.10.0|g' ufs_hercules.gnu.lua
        sed -i 's|/work/noaa/epic/role-epic/spack-stack/hercules/spack-stack-dev-20230825/envs/ufs-pio-2.5.10/install/modulefiles/Core|/work/noaa/epic/role-epic/spack-stack/hercules/spack-stack-1.5.0/envs/unified-env/install/modulefiles/Core|g' ufs_hercules.intel.lua
        sed -i 's|/work/noaa/epic/role-epic/spack-stack/hercules/modulefiles|/work/noaa/epic/role-epic/spack-stack/hercules/modulefiles|g' ufs_hercules.intel.lua  
        sed -i 's|stack_python_ver=os.getenv("stack_python_ver") or "3.9.14"|stack_python_ver=os.getenv("stack_python_ver") or "3.10.8"|g' ufs_hercules.intel.lua 
        sed -i 's|3.3.3|4.3.0|g' ufs_hercules.intel.lua 
        sed -i 's|2.9.2|2.10.0|g' ufs_hercules.intel.lua
        cd ..
        cd tests/
        ./rt.sh -a nems -c -l rt.conf
        echo "Sending regression test logs to $GIT_URL"
        fi
        '''
            }
        }
