mkdir INPUT RESTART history MOM6_OUTPUT

if [[ $ATMRES == C96 ]]; then
  FV3_DIR=FV3_input_data
else
  FV3_DIR=FV3_input_data${ATMRES#C}
fi

ICERES=${OCNRES:0:1}.${OCNRES:1}

if [[ $BMIC == .true. ]]; then
  FV3_IC=@[INPUTDATA_ROOT_BMIC]/${SYEAR}${SMONTH}${SDAY}${SHOUR}/@[FV3BMIC]/@[ATMRES]_L@[NPZ]/INPUT
  MOM_IC=@[INPUTDATA_ROOT_BMIC]/${SYEAR}${SMONTH}${SDAY}${SHOUR}/mom6_da
  ICE_IC=@[INPUTDATA_ROOT_BMIC]/${SYEAR}${SMONTH}${SDAY}${SHOUR}/cpc
else
  FV3_IC=@[INPUTDATA_ROOT]/${FV3_DIR}/INPUT_L127_mx${OCNRES}
  MOM_IC=@[INPUTDATA_ROOT]/MOM6_IC
  ICE_IC=@[INPUTDATA_ROOT]/CICE_IC/${OCNRES}
fi

# FV3 fixed input
cp    @[INPUTDATA_ROOT]/${FV3_DIR}/@[FNSMCC] .
cp    @[INPUTDATA_ROOT]/${FV3_DIR}/@[FNMSKH] .

cp    @[INPUTDATA_ROOT]/FV3_fix_tiled/@[ATMRES]/oro_@[ATMRES].mx@[OCNRES].tile1.nc INPUT/oro_data.tile1.nc
cp    @[INPUTDATA_ROOT]/FV3_fix_tiled/@[ATMRES]/oro_@[ATMRES].mx@[OCNRES].tile2.nc INPUT/oro_data.tile2.nc
cp    @[INPUTDATA_ROOT]/FV3_fix_tiled/@[ATMRES]/oro_@[ATMRES].mx@[OCNRES].tile3.nc INPUT/oro_data.tile3.nc
cp    @[INPUTDATA_ROOT]/FV3_fix_tiled/@[ATMRES]/oro_@[ATMRES].mx@[OCNRES].tile4.nc INPUT/oro_data.tile4.nc
cp    @[INPUTDATA_ROOT]/FV3_fix_tiled/@[ATMRES]/oro_@[ATMRES].mx@[OCNRES].tile5.nc INPUT/oro_data.tile5.nc
cp    @[INPUTDATA_ROOT]/FV3_fix_tiled/@[ATMRES]/oro_@[ATMRES].mx@[OCNRES].tile6.nc INPUT/oro_data.tile6.nc
cp    @[INPUTDATA_ROOT]/FV3_fix_tiled/@[ATMRES]/@[ATMRES]*.nc .

cp    @[INPUTDATA_ROOT]/CPL_FIX/a@[ATMRES]o@[OCNRES]/grid_spec.nc ./INPUT
cp    @[INPUTDATA_ROOT]/${FV3_DIR}/INPUT/@[ATMRES]_grid*.nc ./INPUT
cp    @[INPUTDATA_ROOT]/${FV3_DIR}/INPUT/grid_spec.nc ./INPUT/@[ATMRES]_mosaic.nc

# MOM6 fixed input
cp    @[INPUTDATA_ROOT]/MOM6_FIX/@[OCNRES]/* ./INPUT

# CICE fixed input
cp    @[INPUTDATA_ROOT]/CICE_FIX/@[OCNRES]/grid_cice_NEMS_mx@[OCNRES].nc .
cp    @[INPUTDATA_ROOT]/CICE_FIX/@[OCNRES]/kmtu_cice_NEMS_mx@[OCNRES].nc .
cp    @[INPUTDATA_ROOT]/CICE_FIX/@[OCNRES]/mesh.mx@[OCNRES].nc .

# WW3 fix/input
if [[ $CPLWAV == .true. ]]; then
  cp    @[INPUTDATA_ROOT_WW3]/mod_def.points .
  if [[ $OCNRES == 025 ]]; then
     cp    @[INPUTDATA_ROOT_WW3]/mod_def.mx@[OCNRES]lite mod_def.ww3
  else
     cp    @[INPUTDATA_ROOT_WW3]/mod_def.mx@[OCNRES] mod_def.ww3
  fi
fi

#rrtmgp
if [ $DO_RRTMGP = .true. ]; then
  cp    @[INPUTDATA_ROOT]/FV3_input_data_RRTMGP/* .
fi

OPNREQ_TEST=${OPNREQ_TEST:-false}
SUFFIX=${RT_SUFFIX}
# No restart
if [ $WARM_START = .false. ]; then
  # ICs
  cp    ${FV3_IC}/sfc_data*.nc ./INPUT
  cp    ${FV3_IC}/gfs_data*.nc ./INPUT
  cp    ${FV3_IC}/gfs_ctrl.nc ./INPUT
  if [[ $BMIC == .true. ]]; then
   cp    ${MOM_IC}/MOM*.nc ./INPUT
   cp    ${ICE_IC}/cice5_model_@[ICERES].res_${SYEAR}${SMONTH}${SDAY}00.nc ./cice_model.res.nc
  else
   cp    ${MOM_IC}/MOM6_IC_TS_${SYEAR}${SMONTH}${SDAY}${SHOUR}.nc ./INPUT/MOM6_IC_TS.nc
   cp    ${ICE_IC}/cice_model_@[ICERES].cpc.res_${SYEAR}${SMONTH}${SDAY}.nc ./cice_model.res.nc
  fi
#Restart
else
  if [[ ${OPNREQ_TEST} == true ]]; then
    SUFFIX=${BL_SUFFIX}
  fi

  # Restart files
  cp -r ../${DEP_RUN}${SUFFIX}/INPUT/* ./INPUT
  cp -r ../${DEP_RUN}${SUFFIX}/RESTART/${RESTART_FILE_PREFIX}.* ./INPUT
  for RFILE in INPUT/${RESTART_FILE_PREFIX}.*; do
    [ -e $RFILE ] || exit 1
    RFILE_OLD=$(basename $RFILE)
    mv -f $RFILE INPUT/"${RFILE_OLD//${RESTART_FILE_PREFIX}./}"
  done

  #if not mx025, then mom6 restart is a single file
  if [[ $OCNRES == 025 ]]; then
   cp ../${DEP_RUN}${SUFFIX}/RESTART/MOM.res.${RESTART_FILE_SUFFIX_HRS}-00-00.nc ./INPUT/MOM.res.nc
   cp ../${DEP_RUN}${SUFFIX}/RESTART/MOM.res.${RESTART_FILE_SUFFIX_HRS}-00-00_1.nc ./INPUT/MOM.res_1.nc
   cp ../${DEP_RUN}${SUFFIX}/RESTART/MOM.res.${RESTART_FILE_SUFFIX_HRS}-00-00_2.nc ./INPUT/MOM.res_2.nc
   cp ../${DEP_RUN}${SUFFIX}/RESTART/MOM.res.${RESTART_FILE_SUFFIX_HRS}-00-00_3.nc ./INPUT/MOM.res_3.nc
  else
   cp ../${DEP_RUN}${SUFFIX}/RESTART/MOM.res.${RESTART_FILE_SUFFIX_HRS}-00-00.nc ./INPUT/MOM.res.nc
  fi

  # CMEPS restart and pointer files
  RFILE=ufs.cpld.cpl.r.${RESTART_FILE_SUFFIX_SECS}.nc
  cp  ../${DEP_RUN}${SUFFIX}/RESTART/${RFILE} .
  ls -1 ${RFILE}>rpointer.cpl

  # CICE restart and pointer files
  RFILE=iced.${RESTART_FILE_SUFFIX_SECS}.nc
  cp  ../${DEP_RUN}${SUFFIX}/RESTART/${RFILE} ./INPUT
  ls -1 ./INPUT/${RFILE}>ice.restart_file

  # WAVE restart file
  cp ../${DEP_RUN}${SUFFIX}/${RESTART_FILE_PREFIX}.restart.ww3 ./restart.ww3
fi

#inline post
if [ $WRITE_DOPOST = .true. ]; then
  cp    ${PATHRT}/parm/post_itag itag
  cp    ${PATHRT}/parm/postxconfig-NT.txt postxconfig-NT.txt
  cp    ${PATHRT}/parm/postxconfig-NT_FH00.txt postxconfig-NT_FH00.txt
  cp    ${PATHRT}/parm/params_grib2_tbl_new params_grib2_tbl_new
fi

#merra2
if [ $IAER = 1011 ]; then
  for n in 01 02 03 04 05 06 07 08 09 10 11 12; do
    cp @[INPUTDATA_ROOT]/FV3_input_data_INCCN_aeroclim/MERRA2/merra2.aerclim.2003-2014.m${n}.nc aeroclim.m${n}.nc
  done
  cp    @[INPUTDATA_ROOT]/FV3_input_data_INCCN_aeroclim/aer_data/LUTS/optics_BC.v1_3.dat  optics_BC.dat
  cp    @[INPUTDATA_ROOT]/FV3_input_data_INCCN_aeroclim/aer_data/LUTS/optics_OC.v1_3.dat  optics_OC.dat
  cp    @[INPUTDATA_ROOT]/FV3_input_data_INCCN_aeroclim/aer_data/LUTS/optics_DU.v15_3.dat optics_DU.dat
  cp    @[INPUTDATA_ROOT]/FV3_input_data_INCCN_aeroclim/aer_data/LUTS/optics_SS.v3_3.dat  optics_SS.dat
  cp    @[INPUTDATA_ROOT]/FV3_input_data_INCCN_aeroclim/aer_data/LUTS/optics_SU.v1_3.dat  optics_SU.dat
fi

cp    @[INPUTDATA_ROOT]/FV3_input_data/ugwp_c384_tau.nc ./ugwp_limb_tau.nc
cp    @[INPUTDATA_ROOT]/${FV3_DIR}/INPUT_L127/oro_data_ls* ./INPUT
cp    @[INPUTDATA_ROOT]/${FV3_DIR}/INPUT_L127/oro_data_ss* ./INPUT

if [ $IMP_PHYSICS = 8 ]; then
  cp    @[INPUTDATA_ROOT]/FV3_input_data_gsd/CCN_ACTIVATE.BIN CCN_ACTIVATE.BIN
  cp    @[INPUTDATA_ROOT]/FV3_input_data_gsd/freezeH2O.dat freezeH2O.dat
  cp    @[INPUTDATA_ROOT]/FV3_input_data_gsd/qr_acr_qg.dat qr_acr_qg.dat
  cp    @[INPUTDATA_ROOT]/FV3_input_data_gsd/qr_acr_qs.dat qr_acr_qs.dat
fi

#prognostic aerosols; explictly list files since AERO_HIST.rc is from parm/gocart
if [ $CPLCHM = .true. ]; then
  cp      @[INPUTDATA_ROOT]/GOCART/p8/rc/*instance* .
  cp      @[INPUTDATA_ROOT]/GOCART/p8/rc/AERO_ExtData.rc .
  cp      @[INPUTDATA_ROOT]/GOCART/p8/rc/AERO.rc .
  cp      @[INPUTDATA_ROOT]/GOCART/p8/rc/AGCM.rc .
  cp      @[INPUTDATA_ROOT]/GOCART/p8/rc/CAP.rc .
  cp      @[INPUTDATA_ROOT]/GOCART/p8/rc/GOCART2G_GridComp.rc .
  ln -sf  @[INPUTDATA_ROOT]/GOCART/p8/ExtData .
fi
